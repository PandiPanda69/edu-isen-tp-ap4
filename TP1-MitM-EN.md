# TP1 - Man in the Middle (English version)

_Sébastien Mériot_ ([@smeriot](https://twitter.com/smeriot))

Duration: 2 hours

Setup the environment
=====================

As explained, these exercices will be based on the [MI-LXC](https://github.com/flesueur/mi-lxc) educational platform.

To setup your environment properly, the requirements are:
- [Virtual Box](https://www.virtualbox.org/wiki/Downloads)
- The MI-LXC Virtual Machine preconfigured where is available [here](https://flesueur.irisa.fr/mi-lxc/images/milxc-debian-amd64-1.4.2.ova)

Once the `OVA` file downloaded, open `Virtual Box`, then in the `File` menu, choose `Import Appliance`. Pick the `OVA` file and wait few minutes while the virtual machine is getting created.

Before running the VM, depending on your setup, it can be recommended to lower the RAM allocated to the VM. By default, the VM is configured to use 3GB. If your host has 4GB, you can decrease this value to 2GB or 1.5GB (the VM should work properly).

The deployed infrastructure emulated several devices in an enterprise (firewall, firewall, DMZ, intranet, central authentication, file sharing, several internal workstations of the company _Target_), a workstation of an attacker and few other devices useful for running the platform. We won't detail yet the whole network infrastructure.

> For the most curious of you, the MI-LXC code which generate this VM automaticaly, is available with a documented procedure [here](https://github.com/flesueur/mi-lxc)

You should connect to the VM using the credentials `root/root`. MI-LXC is already installed and the infrastructure deployed. To run the infrastructure, open a terminal and go in the golder `/root/mi-lxc`. Then enter the command `./mi-lxc.py start`. Once started, you can put your hands on !

> In the Virtual Machine and the MI-LXC devices, you can install additional softwares. By default, `Mousepad` can help edit files with a UI. The fullscreen mode can be enabled to display the VM. If it does not work, sometimes you have to change the window size manually by dragging the right lower border, so VirtualBox can detect that the automatic resize feature is available. This feature has to be enabled in the `Screen` menu. If it does not work, try to reboot the VM.

Cheat sheet
===========

You can find below a quick summary of the available commands :

| Commande | Description | Utilisation |
| -------- | ----------- | ----------- |
| print    | Display the network emulated by MI-LXC | ./mi-lxc.py print |
| attach   | Open a new shell on a device | ./mi-lxc.py attach root@target-commercial |
| display  | Open a graphical interface on a device | ./mi-lxc.py display target-commercial |

Note: You should be in the directory  `mi-lxc` to run commands.

Get the hands on
================

In a first time, run a `print` command to display the network generated by MI-LXC. The mapping is large, you can resize the screen to fit with it.
We are going to focus on the network of the little company "target" (target-lan) with the devices prefixed by "target". This network is composed by :

| Machine           | Description |
| :-------:         | ----------- |
| target-router     | Router     |
| target-admin      | Workstation of the system administrator |
| target-commercial | Workstation of the salesman |
| target-dev        | Workstation of the developer |
| target-dmz        | Demilitarized Zone |
| target-ldap       | LDAP of the company |
| target-filer      | File sharing server of the company |
| target-intranet   | Web server for the intranet |

Addressing Plan
===============

This little company has no documentation unfortunately about its network addressing plan. You'll have to do it by yourself.

1. Make a table and recover the network addressing plan. Give for each device, which are the IPv4 and MAC addresses. Explain how you proceed.

**Ask your teacher to validate the addressing plan.**

ARP Spoofing
============

You are going to make an attack called `ARP Spoofing`.

2. Explain quickly what is this attack and how to do it.

For an unknown reason, let say that the developer of the company wants to attack the system administrator in order to steal his Intranet
credentials. The goal of the attack is then to make the system administrator enter his credentials on a web server which is not the
Intranet.

To make this attack, open 2 different terminals and connect to both the developer workstation and the system administrator workstation.


3. On the sysadmin workstation, display the ARP table. Is the intranet server present ?

If it is, then delete it by using the command:  `arp -d <ip_intranet>` (by replacing `<ip_intranet>` by the previously found IP)

To make this attack, we are going to use the tool [arpspoof](https://linux.die.net/man/8/arpspoof) already installed on the developer
workstation. In order to see all the magic behind this attack, you can attach a terminal on the sysadmin workstation and run the command
 `watch -n1 arp -a` that will display and refresh every second the ARP table.
 
In the meanwhile, in the developer terminal, run the command `arpspoof` with the proper arguments in order to make think to the sysadmin
workstation the intranet server is the developer workstation.

4. Do you see any change in the ARP table ? In your opinion, why it doesn't ?

Stop `arpspoof` using CTRL+C (it can take few seconds, the tool tries to revert the changes by reannouncing the real MAC address to the victim).

5. From the sysadmin workstation, run a `curl` command to the intranet server then run again the `watch` command. A new entry shoud appear in the ARP table. Which one ? Why ?
6. Re-run `arpspoof` on the developer workstation. Why the ARP table on the sysadmin workstation did change ? Explain.

MitM Attack
===========

Now, we are going to make a Man in the Middle attack and try to catch and tamper the network traffic.

Re-run the ARP spoofing attack as you did previously. In addition, on the developer workstation, run the tool [urlsnarf](https://linux.die.net/man/8/urlsnarf)
that will display the incoming HTTP requests.

7. From the sysadmin workstation, do a `curl` to the intranet server. Do you receive the response you was expecting ? How do you know it ?

In order to debug and understand the rootcause of the issue, we are going to capture the traffic using `tcpdump`. On the developer
workstation, run the following command that allows you to capture the packs on the HTTP port (TCP/80): `tcpdump 'port http'`.
Then re-run the command `curl`. Then, press CTRL+C to stop `tcpdump`.

8. Analyze the `tcpdump` result. Did any HTTP packets get caught on the developer workstation ? What was the destination IP ? What is the IP of the developer workstation ?
 
By default, the Linux kernel ignores the packets that are not addressed to it. Maybe it could explain why you did not have the expected
behavior. Using `ifconfig`, add a new network interface to solve this issue.

> Helpful: to add a new network interface with `ipconfig`, you can use the following command:
> `ifconfig eth0:bad <ip> netmask <mask> up` by replacing the arguments `ip` and `mask` by the proper values.

9. Check with `ifconfig` that you interface is properly configured. Re-run `curl`. What happened ?
10. Try to explain why, despite your ARP spoofing attack, you had a response on question 8.

Rogue DNS (bonus)
=================

12. In your opinion, why is it interesting to impersonate a DNS server rather than a web server ? 
13. Explain how you would proceed to do so ?
14. In order to avoid disrupting the internal DNS zone of the company, how would you do to get a transparent behavior ?
